<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Student · Parking App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="bg-white border-b">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Student</h1>
      <nav class="text-sm">
        <a class="mr-4 hover:underline" href="/">Home</a>
        <a class="hover:underline" href="/admin">Admin</a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-8 grid md:grid-cols-2 gap-6">
    <!-- Run check -->
    <section class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-lg font-semibold">Check Lot Availability</h2>
      <form id="checkForm" class="mt-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Lot name</label>
          <select id="lotSelect" name="lot_name" class="w-full rounded-xl border px-3 py-2">
            <option>Loading…</option>
          </select>
          <div class="mt-2">
            <button id="refreshLots" type="button" class="text-xs underline text-gray-600">Refresh lots</button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Current lot photo</label>
          <input type="file" name="file" accept="image/*" required
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4
                        file:rounded-xl file:border-0 file:bg-gray-900 file:text-white
                        hover:file:bg-black cursor-pointer"/>
        </div>

        <button class="rounded-xl bg-gray-900 text-white px-4 py-2 hover:bg-black">Analyze</button>
      </form>
      <div id="formMsg" class="text-sm text-gray-700 mt-3"></div>
    </section>

    <!-- Results -->
    <section class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-lg font-semibold">Results</h2>
      <div id="result" class="text-sm text-gray-800 space-y-3">
        <div class="text-gray-500">Submit a photo to see availability.</div>
      </div>
    </section>

    <!-- Analytics quick view -->
    <section class="bg-white shadow rounded-2xl p-6 md:col-span-2">
      <h2 class="text-lg font-semibold">Analytics (optional)</h2>
      <div class="flex gap-2 mt-3">
        <input id="lotAnalytics" class="rounded-xl border px-3 py-2" placeholder="lot name (e.g., lot_a)"/>
        <button id="loadAnalytics" class="rounded-xl bg-gray-200 px-4 py-2">Load</button>
      </div>
      <pre id="analytics" class="mt-4 rounded-xl border p-4 overflow-auto text-xs whitespace-pre-wrap"></pre>
    </section>
  </main>

  <script>
    async function loadLots() {
      try {
        const res = await fetch('/lots');
        const data = await res.json();
        const sel = document.getElementById('lotSelect');
        if (!data.lots || data.lots.length === 0) {
          sel.innerHTML = '<option value="">No lots yet</option>';
          return;
        }
        sel.innerHTML = data.lots.map(l => `<option value="${l}">${l}</option>`).join('');
      } catch (e) {
        document.getElementById('lotSelect').innerHTML = '<option value="">Error loading lots</option>';
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', loadLots);
    document.getElementById('refreshLots').addEventListener('click', loadLots);

    // Submit to /student/check and render UI
    document.getElementById('checkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const msg = document.getElementById('formMsg');
      msg.textContent = 'Analyzing…';
      try {
        const res = await fetch('/student/check', { method: 'POST', body: fd });
        const data = await res.json();
        msg.textContent = '';
        const el = document.getElementById('result');
        el.innerHTML = `
          <div class="rounded-xl border p-3">
            <div><b>Total spots:</b> ${data.total}</div>
            <div><b>Free:</b> ${data.free_count} (${data.empty_spots}%)</div>
            <div><b>Occupied:</b> ${data.occupied_count} (${data.taken_spots}%)</div>
          </div>
          <div class="grid md:grid-cols-2 gap-3">
            <figure class="rounded-xl border overflow-hidden">
              <img src="${data.annotated_image}" alt="Annotated" class="w-full block">
              <figcaption class="p-2 text-xs text-gray-600">Annotated</figcaption>
            </figure>
            <figure class="rounded-xl border overflow-hidden">
              <img src="${data.grid_map}" alt="Grid" class="w-full block">
              <figcaption class="p-2 text-xs text-gray-600">Grid map</figcaption>
            </figure>
          </div>
        `;
      } catch (err) {
        msg.textContent = 'Error analyzing lot.';
        console.error(err);
      }
    });

    // Simple analytics viewer
    document.getElementById('loadAnalytics').addEventListener('click', async () => {
      const name = document.getElementById('lotAnalytics').value.trim();
      if (!name) return;
      const res = await fetch(`/analytics/${encodeURIComponent(name)}`);
      const data = await res.json();
      document.getElementById('analytics').textContent = JSON.stringify(data, null, 2);
    });
  </script>
</body>
</html>